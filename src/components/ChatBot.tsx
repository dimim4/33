import React, { useState, useRef, useEffect } from 'react';
import { MessageCircle, X, Send, Bot, User, Sparkles, Zap, Calendar, ArrowRight, Phone, Mail, Target, TrendingUp, Euro, Clock } from 'lucide-react';

interface Message {
  id: string;
  text: string;
  isBot: boolean;
  timestamp: Date;
  quickReplies?: string[];
  actions?: Array<{
    type: 'calendly' | 'whatsapp' | 'link';
    text: string;
    url?: string;
    message?: string;
  }>;
}

const ChatBot = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [userName, setUserName] = useState('');
  const [userCompany, setUserCompany] = useState('');
  const [conversationStage, setConversationStage] = useState('initial');
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Base de conocimiento de la web
  const knowledgeBase = {
    servicios: {
      principales: [
        "Asistente IA conversacional 24/7 que atiende WhatsApp y llamadas",
        "Automatizaci√≥n completa de agenda de citas",
        "Integraci√≥n con CRM y sistemas existentes",
        "Voz sint√©tica indistinguible de humanos",
        "Respuestas personalizadas con el estilo de tu empresa"
      ],
      beneficios: [
        "Captura 100% de leads las 24 horas",
        "Reduce costes operativos hasta 2.500‚Ç¨/mes",
        "Aumenta conversiones hasta 180%",
        "ROI promedio del 320% en 30 d√≠as",
        "Implementaci√≥n en solo 7 d√≠as"
      ]
    },
    precios: {
      starter: "297‚Ç¨/mes - Hasta 500 conversaciones, WhatsApp + llamadas b√°sicas",
      professional: "497‚Ç¨/mes - Hasta 2.000 conversaciones, IA avanzada, soporte 24/7",
      enterprise: "997‚Ç¨/mes - Conversaciones ilimitadas, suite completa, gestor dedicado"
    },
    garantias: [
      "30 d√≠as de garant√≠a de devoluci√≥n del dinero",
      "Sin permanencia ni penalizaciones",
      "Implementaci√≥n garantizada en 7 d√≠as",
      "Soporte t√©cnico 24/7 incluido"
    ],
    casos_exito: [
      "TechSolutions Madrid: +180% conversiones, 4.200‚Ç¨ ahorrados/mes",
      "InnovaMarketing Barcelona: 6h ahorradas/d√≠a, +95% satisfacci√≥n",
      "GlobalTrade Valencia: +300% clientes internacionales"
    ],
    tecnologia: [
      "GPT-4 Turbo para procesamiento de lenguaje natural",
      "Infraestructura AWS con 99.9% uptime",
      "Encriptaci√≥n AES-256 nivel militar",
      "Cumplimiento GDPR, LOPD, ISO 27001"
    ]
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    if (isOpen && messages.length === 0) {
      setTimeout(() => {
        addBotMessage(
          "¬°Hola! üëã Soy Carlos, consultor especializado en automatizaci√≥n empresarial de IAFY.\n\nVeo que est√°s explorando c√≥mo la IA puede transformar tu negocio. Me dedico a ayudar a empresarios como t√∫ a automatizar su atenci√≥n al cliente y recuperar ingresos que se est√°n perdiendo.\n\n¬øC√≥mo te llamas? Me gusta personalizar la conversaci√≥n üòä",
          ["Mi nombre es...", "Prefiero no decirlo", "¬øQu√© hace exactamente IAFY?", "¬øC√≥mo puedo perder ingresos?"],
          [
            {
              type: 'calendly',
              text: 'üìÖ Agendar demo personalizada',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Hablar por WhatsApp',
              message: `Hola Carlos, vengo del chatbot de IAFY. Me interesa conocer m√°s sobre automatizaci√≥n con IA. ¬øPodr√≠amos hablar?`
            }
          ]
        );
      }, 500);
    }
  }, [isOpen]);

  const addBotMessage = (text: string, quickReplies?: string[], actions?: Message['actions']) => {
    const newMessage: Message = {
      id: Date.now().toString(),
      text,
      isBot: true,
      timestamp: new Date(),
      quickReplies,
      actions
    };
    setMessages(prev => [...prev, newMessage]);
  };

  const addUserMessage = (text: string) => {
    const newMessage: Message = {
      id: Date.now().toString(),
      text,
      isBot: false,
      timestamp: new Date()
    };
    setMessages(prev => [...prev, newMessage]);
  };

  const simulateTyping = () => {
    setIsTyping(true);
    setTimeout(() => {
      setIsTyping(false);
    }, 1000 + Math.random() * 800);
  };

  const scrollToCalendly = () => {
    const calendlySection = document.querySelector('#calendly-section') || 
                           document.querySelector('[data-url*="calendly"]')?.closest('section');
    
    if (calendlySection) {
      calendlySection.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      setTimeout(() => {
        setIsOpen(false);
      }, 1000);
    } else {
      window.open('https://calendly.com/iafyagency/30min?month=2025-06', '_blank');
    }
  };

  const openWhatsApp = (customMessage?: string) => {
    const defaultMessage = customMessage || 
      `Hola Carlos, vengo del chatbot de IAFY. Soy ${userName || 'un empresario'} ${userCompany ? `de ${userCompany}` : ''} y me interesa conocer m√°s sobre c√≥mo la IA puede automatizar mi empresa. ¬øPodr√≠amos hablar?`;
    
    const encodedMessage = encodeURIComponent(defaultMessage);
    const whatsappUrl = `https://wa.me/34621482256?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
    
    setTimeout(() => {
      setIsOpen(false);
    }, 500);
  };

  const analyzeUserIntent = (message: string) => {
    const msg = message.toLowerCase();
    
    if (msg.includes('precio') || msg.includes('coste') || msg.includes('cu√°nto')) return 'pricing';
    if (msg.includes('demo') || msg.includes('ver') || msg.includes('mostrar')) return 'demo';
    if (msg.includes('funciona') || msg.includes('c√≥mo') || msg.includes('qu√© hace')) return 'how_it_works';
    if (msg.includes('caso') || msg.includes('ejemplo') || msg.includes('cliente')) return 'case_studies';
    if (msg.includes('garant√≠a') || msg.includes('seguro') || msg.includes('riesgo')) return 'guarantee';
    if (msg.includes('tiempo') || msg.includes('implementa') || msg.includes('instala')) return 'implementation';
    if (msg.includes('integra') || msg.includes('crm') || msg.includes('sistema')) return 'integration';
    if (msg.includes('seguridad') || msg.includes('datos') || msg.includes('gdpr')) return 'security';
    if (msg.includes('whatsapp') || msg.includes('llamada') || msg.includes('tel√©fono')) return 'channels';
    if (msg.includes('roi') || msg.includes('retorno') || msg.includes('beneficio')) return 'roi';
    
    return 'general';
  };

  const getBotResponse = (userMessage: string): { text: string; quickReplies?: string[]; actions?: Message['actions'] } => {
    const message = userMessage.toLowerCase();
    const intent = analyzeUserIntent(message);

    // ETAPA 1: CUALIFICACI√ìN INICIAL
    if (conversationStage === 'initial') {
      if (message.includes('mi nombre es') || message.includes('soy') || message.includes('me llamo')) {
        const nameMatch = userMessage.match(/(?:mi nombre es|soy|me llamo)\s+([a-z√°√©√≠√≥√∫√±\s]+)/i);
        if (nameMatch) {
          setUserName(nameMatch[1].trim());
          setConversationStage('qualifying');
          return {
            text: `Encantado de conocerte, ${nameMatch[1].trim()}! ü§ù\n\nComo consultor especializado, he ayudado a m√°s de 20 empresas a automatizar su atenci√≥n al cliente. La mayor√≠a descubre que est√° perdiendo entre 1.500‚Ç¨ y 3.000‚Ç¨ al mes por no tener IA.\n\n¬øCu√°l es el nombre de tu empresa? Me ayuda a entender mejor tu situaci√≥n espec√≠fica.`,
            actions: [
              {
                type: 'calendly',
                text: 'üìÖ An√°lisis personalizado (30 min)',
              },
              {
                type: 'whatsapp',
                text: 'üí¨ Hablar directamente',
                message: `Hola Carlos, soy ${nameMatch[1].trim()} y me interesa un an√°lisis personalizado para mi empresa. ¬øPodr√≠amos hablar?`
              }
            ],
            quickReplies: ["Mi empresa es...", "Trabajo por cuenta propia", "¬øC√≥mo calculas las p√©rdidas?", "Quiero saber m√°s"]
          };
        }
      }

      if (message.includes('prefiero no') || message.includes('no decirlo')) {
        setConversationStage('qualifying');
        return {
          text: "Perfecto, lo entiendo. üëç\n\nD√©jame preguntarte algo que veo en el 90% de empresas: ¬øtu negocio recibe llamadas o mensajes fuera del horario laboral que no pueden ser atendidos?\n\nEsta es una de las principales fuentes de p√©rdida de ingresos que identifico en mis consultas.",
          actions: [
            {
              type: 'whatsapp',
              text: 'üí¨ Evaluar mi situaci√≥n',
              message: `Hola Carlos, me interesa que eval√∫es la situaci√≥n de mi empresa respecto a llamadas perdidas y automatizaci√≥n.`
            },
            {
              type: 'calendly',
              text: 'üìÖ Demo personalizada',
            }
          ],
          quickReplies: ["S√≠, muchas llamadas perdidas", "Solo algunas veces", "¬øC√≥mo lo solucion√°is?", "Quiero una evaluaci√≥n"]
        };
      }

      if (message.includes('qu√© hace') || message.includes('iafy')) {
        return {
          text: `IAFY es la plataforma l√≠der en Espa√±a para automatizaci√≥n empresarial con IA. üöÄ\n\n**Lo que hacemos:**\n${knowledgeBase.servicios.principales.map(s => `‚Ä¢ ${s}`).join('\n')}\n\n**Resultados t√≠picos:**\n${knowledgeBase.servicios.beneficios.map(b => `‚Ä¢ ${b}`).join('\n')}\n\nLa clave est√° en que cada implementaci√≥n es personalizada para tu empresa espec√≠fica.\n\n¬øTe gustar√≠a ver c√≥mo funcionar√≠a en tu caso particular?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ Ver mi caso espec√≠fico',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Consulta personalizada',
              message: `Hola Carlos, he visto lo que hace IAFY y me gustar√≠a una consulta personalizada para mi empresa.`
            }
          ],
          quickReplies: ["Ver mi caso", "¬øCu√°nto cuesta?", "Casos de √©xito", "Demo personalizada"]
        };
      }

      if (message.includes('perder ingresos') || message.includes('30.000')) {
        return {
          text: "Te explico por qu√© muchas empresas pierden esa cantidad sin darse cuenta:\n\n**Principales fuentes de p√©rdida:**\n‚Ä¢ **Llamadas no atendidas:** 40% promedio = 600-800‚Ç¨/d√≠a\n‚Ä¢ **Horario limitado:** 16h sin atenci√≥n = oportunidades perdidas\n‚Ä¢ **Personal administrativo:** 2.000-3.000‚Ç¨/mes en tareas automatizables\n‚Ä¢ **Respuesta lenta:** Clientes que se van a la competencia\n\n**Total anual:** Entre 20.000‚Ç¨ y 40.000‚Ç¨ dependiendo del tama√±o de la empresa.\n\n¬øTe suena familiar alguna de estas situaciones?",
          actions: [
            {
              type: 'whatsapp',
              text: 'üí¨ Calcular mis p√©rdidas exactas',
              message: `Hola Carlos, me interesa calcular las p√©rdidas exactas de mi empresa por no tener automatizaci√≥n.`
            },
            {
              type: 'calendly',
              text: 'üìä An√°lisis de p√©rdidas personalizado',
            }
          ],
          quickReplies: ["S√≠, me suena", "¬øC√≥mo lo calcul√°is?", "Quiero una soluci√≥n", "An√°lisis personalizado"]
        };
      }

      return {
        text: "Entiendo que quieres conocer m√°s detalles. Como consultor, mi enfoque es siempre entender primero tu situaci√≥n espec√≠fica antes de hacer recomendaciones.\n\nCada empresa es diferente, pero hay patrones comunes que he identificado en m√°s de 20 implementaciones exitosas.\n\n¬øQu√© te gustar√≠a saber espec√≠ficamente sobre automatizaci√≥n con IA?",
        actions: [
          {
            type: 'calendly',
            text: 'üìÖ Consulta personalizada',
          },
          {
            type: 'whatsapp',
            text: 'üí¨ Hablar directamente',
            message: `Hola Carlos, me gustar√≠a conocer m√°s sobre automatizaci√≥n con IA para mi empresa.`
          }
        ],
        quickReplies: ["¬øC√≥mo funciona?", "Casos de √©xito", "Precios", "Demo personalizada"]
      };
    }

    // RESPUESTAS BASADAS EN INTENCI√ìN
    switch (intent) {
      case 'pricing':
        setConversationStage('closing');
        return {
          text: `Perfecto ${userName ? userName : ''}, hablemos de inversi√≥n y retorno. üí∞\n\n**Nuestros planes principales:**\n\n**Professional (497‚Ç¨/mes)** - El m√°s popular:\n‚Ä¢ Hasta 2.000 conversaciones\n‚Ä¢ IA avanzada 24/7\n‚Ä¢ Soporte prioritario\n‚Ä¢ ROI promedio: 320%\n\n**Starter (297‚Ç¨/mes)** - Para empezar:\n‚Ä¢ Hasta 500 conversaciones\n‚Ä¢ Funciones b√°sicas\n‚Ä¢ Soporte est√°ndar\n\nLa mayor√≠a de nuestros clientes recupera la inversi√≥n en el primer mes y genera entre 1.500‚Ç¨ y 3.000‚Ç¨ extra mensualmente.\n\n¬øTe gustar√≠a que calculemos el ROI espec√≠fico para tu empresa?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìä Calcular mi ROI espec√≠fico',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Consulta sobre planes',
              message: `Hola Carlos, me interesan los planes de IAFY. ¬øPodr√≠amos hablar sobre cu√°l ser√≠a el mejor para mi empresa?`
            }
          ],
          quickReplies: ["Calcular mi ROI", "¬øGarant√≠as incluidas?", "Empezar con Starter", "¬øCu√°ndo veo resultados?"]
        };

      case 'demo':
        return {
          text: `¬°Excelente decisi√≥n ${userName ? userName : ''}! üéØ\n\nLa demo personalizada es la mejor forma de ver el potencial real para tu empresa.\n\n**En 30 minutos ver√°s:**\n‚Ä¢ An√°lisis de tu situaci√≥n actual\n‚Ä¢ C√°lculo de p√©rdidas espec√≠ficas\n‚Ä¢ Demostraci√≥n en vivo de la IA\n‚Ä¢ Plan de implementaci√≥n personalizado\n‚Ä¢ ROI proyectado para tu caso\n\nNo es una presentaci√≥n gen√©rica, sino un an√°lisis espec√≠fico de tu empresa.\n\n¬øPrefieres agendar directamente o que hablemos primero por WhatsApp?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ Agendar demo ahora',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Hablar antes de agendar',
              message: `Hola Carlos, me interesa la demo personalizada de IAFY. ¬øPodr√≠amos hablar primero para que me cuentes m√°s detalles?`
            }
          ],
          quickReplies: ["Agendar ahora", "¬øQu√© ver√© exactamente?", "Hablar primero", "¬øCu√°nto dura?"]
        };

      case 'how_it_works':
        return {
          text: `Te explico el proceso completo, ${userName ? userName : ''}. Es m√°s sencillo de lo que parece: üîß\n\n**Implementaci√≥n (7 d√≠as):**\nüìÖ **D√≠as 1-2:** An√°lisis y configuraci√≥n inicial\nüìÖ **D√≠as 3-5:** Entrenamiento de la IA con tu informaci√≥n\nüìÖ **D√≠as 6-7:** Pruebas y lanzamiento\n\n**Funcionamiento diario:**\n‚Ä¢ La IA atiende WhatsApp y llamadas 24/7\n‚Ä¢ Responde con el estilo de tu empresa\n‚Ä¢ Agenda citas autom√°ticamente\n‚Ä¢ Transfiere casos complejos a tu equipo\n‚Ä¢ Aprende continuamente de cada interacci√≥n\n\n¬øHay alg√∫n aspecto espec√≠fico que te gustar√≠a que profundice?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ Ver funcionamiento en vivo',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Resolver dudas espec√≠ficas',
              message: `Hola Carlos, tengo algunas dudas espec√≠ficas sobre c√≥mo funciona IAFY. ¬øPodr√≠amos hablar?`
            }
          ],
          quickReplies: ["Ver en vivo", "¬øQu√© necesit√°is de m√≠?", "¬øInterrumpe mi negocio?", "Empezar proceso"]
        };

      case 'case_studies':
        return {
          text: `Te comparto algunos casos reales que pueden inspirarte: üìà\n\n${knowledgeBase.casos_exito.map(caso => `üè¢ **${caso}**`).join('\n\n')}\n\n**Lo que tienen en com√∫n:**\n‚Ä¢ Implementaci√≥n r√°pida (7 d√≠as)\n‚Ä¢ Resultados visibles desde el primer mes\n‚Ä¢ Equipo m√°s enfocado en tareas de valor\n‚Ä¢ Clientes m√°s satisfechos\n\nCada caso es √∫nico, pero los patrones de √©xito son similares.\n\n¬øTe gustar√≠a que analicemos el potencial espec√≠fico para tu empresa?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìä Analizar mi potencial',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Hablar sobre mi caso',
              message: `Hola Carlos, he visto los casos de √©xito y me gustar√≠a hablar sobre el potencial para mi empresa.`
            }
          ],
          quickReplies: ["Analizar mi caso", "¬øC√≥mo lo consegu√≠s?", "Empezar proceso", "M√°s detalles"]
        };

      case 'guarantee':
        return {
          text: `Excelente pregunta ${userName ? userName : ''}. Nuestras garant√≠as son muy s√≥lidas: üõ°Ô∏è\n\n${knowledgeBase.garantias.map(g => `‚úÖ **${g}**`).join('\n')}\n\n**Adem√°s:**\n‚Ä¢ Si no funciona en 7 d√≠as, trabajamos gratis hasta que est√© perfecto\n‚Ä¢ M√°s de 20 empresas nos respaldan con 95% de satisfacci√≥n\n‚Ä¢ Proceso probado y refinado\n\nLa realidad es que estamos tan seguros de los resultados que asumimos todo el riesgo.\n\n¬øHay alg√∫n aspecto espec√≠fico de las garant√≠as que te preocupe?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ Empezar sin riesgo',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Aclarar dudas sobre garant√≠as',
              message: `Hola Carlos, me interesan las garant√≠as de IAFY. ¬øPodr√≠amos hablar sobre los detalles?`
            }
          ],
          quickReplies: ["Empezar sin riesgo", "¬øQu√© m√°s incluye?", "Hablar con referencia", "Proceso de garant√≠a"]
        };

      case 'implementation':
        return {
          text: `La implementaci√≥n es sorprendentemente r√°pida y sencilla ${userName ? userName : ''}: ‚ö°\n\n**Cronograma detallado:**\nüìÖ **D√≠as 1-2:** Configuraci√≥n (nosotros trabajamos, t√∫ sigues normal)\nüìÖ **D√≠as 3-5:** Entrenamiento IA (proceso autom√°tico)\nüìÖ **D√≠as 6-7:** Pruebas y lanzamiento suave\n\n**Lo que necesitamos de ti:**\n‚Ä¢ 2-3 horas de tu tiempo total\n‚Ä¢ Informaci√≥n sobre tu empresa y servicios\n‚Ä¢ Acceso a WhatsApp Business\n‚Ä¢ Feedback durante las pruebas\n\n**Garant√≠a:** Si no est√° funcionando en 7 d√≠as, trabajamos gratis hasta que est√© perfecto.\n\n¬øTe parece un cronograma razonable?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ Planificar implementaci√≥n',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Detalles de implementaci√≥n',
              message: `Hola Carlos, me interesa conocer m√°s detalles sobre el proceso de implementaci√≥n de IAFY.`
            }
          ],
          quickReplies: ["Planificar implementaci√≥n", "¬øQu√© necesit√°is exactamente?", "¬øInterrumpe mi negocio?", "Empezar proceso"]
        };

      default:
        return {
          text: `Entiendo tu inter√©s ${userName ? userName : ''}. Como consultor especializado, mi objetivo es ayudarte a tomar la mejor decisi√≥n para tu empresa.\n\nCada situaci√≥n es √∫nica, pero hay patrones comunes que he identificado en m√°s de 20 implementaciones exitosas.\n\nLa mejor forma de evaluar si IAFY es adecuado para ti es con una demo personalizada donde analizamos tu caso espec√≠fico.\n\n¬øQu√© te parece si agendamos 30 minutos para hacer un an√°lisis sin compromiso?`,
          actions: [
            {
              type: 'calendly',
              text: 'üìÖ An√°lisis sin compromiso',
            },
            {
              type: 'whatsapp',
              text: 'üí¨ Consulta previa',
              message: `Hola Carlos, me gustar√≠a una consulta previa antes de agendar la demo de IAFY.`
            }
          ],
          quickReplies: ["An√°lisis sin compromiso", "Consulta previa", "¬øQu√© analizar√≠amos?", "M√°s informaci√≥n"]
        };
    }
  };

  const handleSendMessage = () => {
    if (!inputText.trim()) return;

    addUserMessage(inputText);
    const userMessage = inputText;
    setInputText('');

    simulateTyping();
    setTimeout(() => {
      const response = getBotResponse(userMessage);
      addBotMessage(response.text, response.quickReplies, response.actions);
    }, 1000 + Math.random() * 800);
  };

  const handleQuickReply = (reply: string) => {
    addUserMessage(reply);
    simulateTyping();
    setTimeout(() => {
      const response = getBotResponse(reply);
      addBotMessage(response.text, response.quickReplies, response.actions);
    }, 800);
  };

  const handleAction = (action: NonNullable<Message['actions']>[0]) => {
    if (action.type === 'calendly') {
      scrollToCalendly();
    } else if (action.type === 'whatsapp') {
      openWhatsApp(action.message);
    } else if (action.type === 'link' && action.url) {
      window.open(action.url, '_blank');
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  return (
    <>
      {/* Bot√≥n flotante del chatbot */}
      <div className="fixed bottom-6 right-6 z-50">
        {!isOpen && (
          <button
            onClick={() => setIsOpen(true)}
            className="group relative"
          >
            {/* Efecto de brillo */}
            <div className="absolute -inset-4 bg-gradient-to-r from-primary-500 via-success-500 to-electric-500 rounded-full blur-xl opacity-50 group-hover:opacity-70 transition-opacity duration-300 animate-pulse"></div>
            
            {/* Bot√≥n principal */}
            <div className="relative bg-gradient-to-br from-white/15 to-white/5 backdrop-blur-sm p-4 rounded-full border border-white/30 shadow-spectacular hover:scale-110 transition-all duration-300">
              <div className="flex items-center">
                <MessageCircle className="w-6 h-6 text-white" />
                
                {/* Badge de consultor */}
                <div className="absolute -top-3 -right-3 bg-primary-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse shadow-lg">
                  CONSULTOR
                </div>
              </div>
            </div>

            {/* Tooltip */}
            <div className="absolute bottom-full right-0 mb-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div className="bg-neutral-900 text-white px-4 py-3 rounded-xl text-sm whitespace-nowrap shadow-xl border border-primary-400/30">
                <div className="font-bold text-primary-400">üíº Carlos - Consultor IA</div>
                <div className="text-neutral-300">¬øAutomatizamos tu empresa?</div>
                <div className="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-neutral-900"></div>
              </div>
            </div>
          </button>
        )}
      </div>

      {/* Ventana del chatbot */}
      {isOpen && (
        <div className="fixed bottom-6 right-6 w-96 h-[600px] bg-gradient-to-br from-neutral-900 to-neutral-800 rounded-3xl shadow-2xl border border-neutral-700/50 z-50 flex flex-col overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-primary-600 via-success-600 to-electric-600 p-4 flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="relative">
                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center border-2 border-white/30">
                  <Bot className="w-7 h-7 text-white" />
                </div>
                <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-success-400 rounded-full border-2 border-white flex items-center justify-center">
                  <Target className="w-3 h-3 text-white" />
                </div>
              </div>
              <div>
                <h3 className="text-white font-bold text-lg">Carlos - Consultor IA</h3>
                <p className="text-primary-100 text-sm flex items-center">
                  <TrendingUp className="w-3 h-3 mr-1" />
                  Especialista en automatizaci√≥n ‚Ä¢ +20 empresas
                </p>
              </div>
            </div>
            <button
              onClick={() => setIsOpen(false)}
              className="text-white/80 hover:text-white transition-colors duration-200 p-1"
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((message) => (
              <div key={message.id} className={`flex ${message.isBot ? 'justify-start' : 'justify-end'}`}>
                <div className={`max-w-[85%] ${message.isBot ? 'order-2' : 'order-1'}`}>
                  {message.isBot && (
                    <div className="flex items-center space-x-2 mb-2">
                      <Bot className="w-4 h-4 text-primary-400" />
                      <span className="text-xs text-neutral-400 font-semibold">Carlos - Consultor IAFY</span>
                      <div className="w-2 h-2 bg-success-400 rounded-full animate-pulse"></div>
                    </div>
                  )}
                  <div className={`p-4 rounded-2xl ${
                    message.isBot 
                      ? 'bg-gradient-to-r from-primary-600/20 via-success-600/20 to-electric-600/20 border border-primary-500/30 text-white' 
                      : 'bg-gradient-to-r from-success-600 to-primary-600 text-white'
                  }`}>
                    <p className="whitespace-pre-line text-sm leading-relaxed font-medium">{message.text}</p>
                  </div>
                  
                  {/* Action buttons */}
                  {message.actions && (
                    <div className="mt-3 space-y-2">
                      {message.actions.map((action, index) => (
                        <button
                          key={index}
                          onClick={() => handleAction(action)}
                          className="block w-full text-left px-4 py-3 text-sm bg-gradient-to-r from-success-600 to-primary-600 hover:from-success-500 hover:to-primary-500 text-white rounded-xl border border-success-400/50 hover:border-success-400 transition-all duration-200 transform hover:scale-105 font-bold shadow-lg"
                        >
                          <div className="flex items-center justify-between">
                            <span>{action.text}</span>
                            <ArrowRight className="w-4 h-4" />
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                  
                  {/* Quick replies */}
                  {message.quickReplies && (
                    <div className="mt-3 space-y-1">
                      {message.quickReplies.map((reply, index) => (
                        <button
                          key={index}
                          onClick={() => handleQuickReply(reply)}
                          className="block w-full text-left px-3 py-2 text-sm bg-neutral-800/50 hover:bg-neutral-700/50 text-neutral-300 hover:text-white rounded-lg border border-neutral-600/30 hover:border-primary-500/50 transition-all duration-200 font-medium"
                        >
                          {reply}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                {message.isBot && (
                  <div className="order-1 mr-2">
                    <div className="w-8 h-8 bg-gradient-to-r from-primary-500 via-success-500 to-electric-500 rounded-full flex items-center justify-center">
                      <Bot className="w-4 h-4 text-white" />
                    </div>
                  </div>
                )}
                {!message.isBot && (
                  <div className="order-2 ml-2">
                    <div className="w-8 h-8 bg-gradient-to-r from-success-500 to-primary-500 rounded-full flex items-center justify-center">
                      <User className="w-4 h-4 text-white" />
                    </div>
                  </div>
                )}
              </div>
            ))}
            
            {/* Typing indicator */}
            {isTyping && (
              <div className="flex justify-start">
                <div className="flex items-center space-x-2">
                  <div className="w-8 h-8 bg-gradient-to-r from-primary-500 via-success-500 to-electric-500 rounded-full flex items-center justify-center">
                    <Bot className="w-4 h-4 text-white" />
                  </div>
                  <div className="bg-gradient-to-r from-primary-600/20 via-success-600/20 to-electric-600/20 border border-primary-500/30 p-3 rounded-2xl">
                    <div className="flex space-x-1">
                      <div className="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div>
                      <div className="w-2 h-2 bg-success-400 rounded-full animate-bounce delay-100"></div>
                      <div className="w-2 h-2 bg-electric-400 rounded-full animate-bounce delay-200"></div>
                    </div>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="p-4 border-t border-neutral-700/50">
            <div className="flex space-x-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Escribe tu pregunta..."
                className="flex-1 bg-neutral-800/50 border border-neutral-600/50 rounded-xl px-4 py-3 text-white placeholder-neutral-400 focus:outline-none focus:border-primary-500/50 transition-colors duration-200"
              />
              <button
                onClick={handleSendMessage}
                disabled={!inputText.trim()}
                className="bg-gradient-to-r from-primary-600 via-success-600 to-electric-600 hover:from-primary-500 hover:via-success-500 hover:to-electric-500 disabled:opacity-50 disabled:cursor-not-allowed text-white p-3 rounded-xl transition-all duration-200 transform hover:scale-105"
              >
                <Send className="w-5 h-5" />
              </button>
            </div>
            
            {/* Quick actions */}
            <div className="flex space-x-2 mt-3">
              <button
                onClick={() => handleQuickReply("Demo personalizada")}
                className="flex-1 bg-gradient-to-r from-success-600/20 to-primary-600/20 border border-success-500/30 text-success-400 px-3 py-2 rounded-lg text-xs font-bold hover:bg-success-600/30 transition-all duration-200"
              >
                <Calendar className="w-3 h-3 inline mr-1" />
                DEMO
              </button>
              <button
                onClick={() => handleQuickReply("¬øCu√°nto cuesta?")}
                className="flex-1 bg-gradient-to-r from-primary-600/20 to-electric-600/20 border border-primary-500/30 text-primary-400 px-3 py-2 rounded-lg text-xs font-bold hover:bg-primary-600/30 transition-all duration-200"
              >
                <Euro className="w-3 h-3 inline mr-1" />
                PRECIO
              </button>
              <button
                onClick={() => openWhatsApp()}
                className="flex-1 bg-gradient-to-r from-electric-600/20 to-success-600/20 border border-electric-500/30 text-electric-400 px-3 py-2 rounded-lg text-xs font-bold hover:bg-electric-600/30 transition-all duration-200"
              >
                <Phone className="w-3 h-3 inline mr-1" />
                LLAMAR
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default ChatBot;